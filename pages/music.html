<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music | Itay Bracha</title>
  <meta name="description" content="Listen to original music by Itay Bracha with immersive audio-reactive visuals.">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <canvas id="bg-canvas"></canvas>
  <div class="music-visualizer-bg" id="music-bg"></div>

  <nav class="nav" role="navigation" aria-label="Main navigation">
    <a href="../index.html" class="nav__logo">ITAY BRACHA</a>
    <ul class="nav__links">
      <li><a href="../index.html">Home</a></li>
      <li><a href="projects.html">Projects</a></li>
      <li><a href="music.html" class="active">Music</a></li>
      <li><a href="videos.html">Videos</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="surprise.html">Surprise</a></li>
    </ul>
    <div class="nav__burger" aria-label="Toggle menu">
      <span></span><span></span><span></span>
    </div>
  </nav>

  <main class="main-content">
    <section class="section">
      <h1 class="section__title reveal">Music</h1>
      <p class="section__subtitle reveal">Original productions. Hit play and watch the atmosphere come alive.</p>

      <div class="music-players" id="music-players">
        <!-- Players generated by JS -->
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>&copy; 2026 Itay Bracha. All rights reserved.</p>
  </footer>

  <script src="../js/bg3d.js"></script>
  <script src="../js/audio-engine.js"></script>
  <script src="../js/nav.js"></script>
  <script>
  (function() {
    // Use encodeURIComponent for Hebrew filename
    var trackFile = '../assets/music/' + encodeURIComponent('אוגי האוגר') + '.mp3';

    var tracks = [
      {
        title: '\u05D0\u05D5\u05D2\u05D9 \u05D4\u05D0\u05D5\u05D2\u05E8',
        artist: 'Itay Bracha',
        hue: 280,
        icon: '\uD83D\uDC39',
        src: trackFile
      }
    ];

    var container = document.getElementById('music-players');
    var musicBg = document.getElementById('music-bg');

    // We'll use the shared AudioContext from audio-engine.js
    var audioCtx = null;
    var playerAnalyser = null;
    var dataArray = null;
    var playerGain = null;
    var activeIndex = -1;

    // Each track gets its own Audio element + source node (created once)
    var trackAudios = [];
    var trackSources = [];
    var trackConnected = [];

    // Atmospheric particles
    var atmosParticles = [];
    function createAtmosParticles() {
      atmosParticles.forEach(function(p) { p.el.remove(); });
      atmosParticles = [];
      for (var i = 0; i < 6; i++) {
        var el = document.createElement('div');
        el.classList.add('atmos-particle');
        var size = 200 + Math.random() * 300;
        el.style.width = size + 'px';
        el.style.height = size + 'px';
        el.style.left = Math.random() * 100 + '%';
        el.style.top = Math.random() * 100 + '%';
        document.body.appendChild(el);
        atmosParticles.push({
          el: el, baseX: Math.random() * 100, baseY: Math.random() * 100,
          speed: 0.5 + Math.random() * 1, phase: Math.random() * Math.PI * 2
        });
      }
    }

    function updateAtmosphere(hue, intensity) {
      var h = hue || 200;
      var it = intensity || 0;
      musicBg.style.background = 'radial-gradient(ellipse at 50% 50%, hsla(' + h + ', 60%, ' + (5 + it * 15) + '%, 0.4) 0%, transparent 70%)';
      atmosParticles.forEach(function(p, idx) {
        var t = Date.now() * 0.001 * p.speed + p.phase;
        p.el.style.left = (p.baseX + Math.sin(t) * 10) + '%';
        p.el.style.top = (p.baseY + Math.cos(t * 0.7) * 8) + '%';
        p.el.style.background = 'hsla(' + (h + idx * 30) + ', 70%, 50%, ' + (0.05 + it * 0.15) + ')';
        p.el.style.opacity = 0.3 + it * 0.5;
      });
      if (window.bgSetHue) window.bgSetHue(h);
    }

    function formatTime(s) {
      if (!s || isNaN(s)) return '0:00';
      var m = Math.floor(s / 60);
      var sec = Math.floor(s % 60);
      return m + ':' + (sec < 10 ? '0' : '') + sec;
    }

    function ensureAudioCtx() {
      if (audioCtx) return;
      // Get the shared context from audio-engine.js
      audioCtx = window.getAudioContext ? window.getAudioContext() : new (window.AudioContext || window.webkitAudioContext)();

      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }

      // Create a dedicated analyser for the music player
      playerAnalyser = audioCtx.createAnalyser();
      playerAnalyser.fftSize = 256;
      playerAnalyser.smoothingTimeConstant = 0.8;
      dataArray = new Uint8Array(playerAnalyser.frequencyBinCount);

      playerGain = audioCtx.createGain();
      playerGain.gain.value = 0.8;

      playerAnalyser.connect(playerGain);
      playerGain.connect(audioCtx.destination);
    }

    function getOrCreateTrackAudio(idx) {
      if (trackAudios[idx]) return trackAudios[idx];

      var audio = new Audio();
      audio.src = tracks[idx].src;
      // No crossOrigin for same-origin files
      trackAudios[idx] = audio;
      trackConnected[idx] = false;
      return audio;
    }

    function connectTrackToAnalyser(idx) {
      if (trackConnected[idx]) return;
      var audio = trackAudios[idx];
      try {
        var source = audioCtx.createMediaElementSource(audio);
        source.connect(playerAnalyser);
        trackSources[idx] = source;
        trackConnected[idx] = true;
      } catch (err) {
        console.warn('Could not connect track to analyser:', err);
      }
    }

    // Build player UI for each track
    tracks.forEach(function(track, index) {
      var player = document.createElement('div');
      player.classList.add('music-player', 'reveal');
      player.style.transitionDelay = (index * 0.1) + 's';
      player.innerHTML =
        '<div class="music-player__art">' +
          '<span>' + track.icon + '</span>' +
          '<div class="music-player__art-vinyl"></div>' +
        '</div>' +
        '<div class="music-player__info">' +
          '<div class="music-player__title">' + track.title + '</div>' +
          '<div class="music-player__artist">' + track.artist + '</div>' +
          '<div class="music-player__progress" data-index="' + index + '">' +
            '<div class="music-player__progress-fill" style="width:0%"></div>' +
          '</div>' +
          '<div class="music-player__time">' +
            '<span class="music-player__time-current">0:00</span>' +
            '<span class="music-player__time-total">--:--</span>' +
          '</div>' +
        '</div>' +
        '<div class="music-player__controls">' +
          '<button class="music-player__btn music-player__btn--play" data-index="' + index + '" aria-label="Play ' + track.title + '">&#9654;</button>' +
          '<div class="music-player__volume">' +
            '<span style="font-size:0.8rem">&#128266;</span>' +
            '<input type="range" class="music-player__volume-slider" min="0" max="100" value="80" aria-label="Volume">' +
          '</div>' +
        '</div>';
      container.appendChild(player);
    });

    // Playback controls
    document.querySelectorAll('.music-player__btn--play').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var idx = parseInt(btn.dataset.index);
        var players = document.querySelectorAll('.music-player');
        var track = tracks[idx];

        // If currently playing this track, pause it
        if (activeIndex === idx && trackAudios[idx] && !trackAudios[idx].paused) {
          trackAudios[idx].pause();
          players[idx].classList.remove('playing');
          btn.innerHTML = '&#9654;';
          window.__musicPageAnalyser = null;
          if (window.bgMusicResume) window.bgMusicResume();
          activeIndex = -1;
          return;
        }

        // Stop any previously playing track
        if (activeIndex >= 0 && trackAudios[activeIndex]) {
          trackAudios[activeIndex].pause();
          players[activeIndex].classList.remove('playing');
          players[activeIndex].querySelector('.music-player__btn--play').innerHTML = '&#9654;';
        }

        // Pause background music
        if (window.bgMusicPause) window.bgMusicPause();

        // Ensure audio context is ready
        ensureAudioCtx();

        // Get or create the audio element for this track
        var audio = getOrCreateTrackAudio(idx);
        connectTrackToAnalyser(idx);

        // Tell bg3d to use our analyser
        window.__musicPageAnalyser = playerAnalyser;

        activeIndex = idx;
        players[idx].classList.add('playing');
        btn.innerHTML = '&#10074;&#10074;';

        // Update duration display
        function onMeta() {
          players[idx].querySelector('.music-player__time-total').textContent = formatTime(audio.duration);
        }
        if (audio.duration && !isNaN(audio.duration)) {
          onMeta();
        } else {
          audio.addEventListener('loadedmetadata', onMeta, { once: true });
        }

        audio.addEventListener('ended', function() {
          players[idx].classList.remove('playing');
          btn.innerHTML = '&#9654;';
          activeIndex = -1;
          window.__musicPageAnalyser = null;
          if (window.bgMusicResume) window.bgMusicResume();
        }, { once: true });

        audio.addEventListener('error', function(e) {
          console.error('Track load error:', audio.src, e);
          players[idx].classList.remove('playing');
          btn.innerHTML = '&#9654;';
          activeIndex = -1;
        }, { once: true });

        audio.play().catch(function(err) {
          console.error('Track play error:', err);
        });
      });
    });

    // Seek on progress bar click
    document.querySelectorAll('.music-player__progress').forEach(function(bar) {
      bar.addEventListener('click', function(e) {
        var idx = parseInt(bar.dataset.index);
        if (!trackAudios[idx] || isNaN(trackAudios[idx].duration)) return;
        var rect = bar.getBoundingClientRect();
        var pct = (e.clientX - rect.left) / rect.width;
        trackAudios[idx].currentTime = pct * trackAudios[idx].duration;
      });
    });

    // Volume control
    document.querySelectorAll('.music-player__volume-slider').forEach(function(slider) {
      slider.addEventListener('input', function() {
        if (playerGain) playerGain.gain.value = slider.value / 100;
      });
    });

    // UI update loop — progress bar + analyser visuals
    function uiLoop() {
      if (activeIndex >= 0 && trackAudios[activeIndex] && !trackAudios[activeIndex].paused) {
        var audio = trackAudios[activeIndex];
        var player = document.querySelectorAll('.music-player')[activeIndex];
        if (player && audio.duration) {
          var pct = (audio.currentTime / audio.duration) * 100;
          player.querySelector('.music-player__progress-fill').style.width = pct + '%';
          player.querySelector('.music-player__time-current').textContent = formatTime(audio.currentTime);
        }

        // Feed local atmosphere from analyser
        if (playerAnalyser && dataArray) {
          playerAnalyser.getByteFrequencyData(dataArray);
          var len = dataArray.length;
          var bassSum = 0;
          var bassEnd = Math.max(1, Math.floor(len * 0.15));
          for (var i = 0; i < bassEnd; i++) bassSum += dataArray[i] / 255;
          var bass = bassSum / bassEnd;
          updateAtmosphere(tracks[activeIndex].hue, bass);
        }
      }
      requestAnimationFrame(uiLoop);
    }

    createAtmosParticles();
    uiLoop();

    // Idle atmosphere animation
    (function idleAtmos() {
      if (activeIndex < 0) {
        var t = Date.now() * 0.001;
        updateAtmosphere(200 + Math.sin(t * 0.2) * 30, 0.08 + Math.sin(t * 0.5) * 0.04);
      }
      requestAnimationFrame(idleAtmos);
    })();
  })();
  </script>
</body>
</html>
